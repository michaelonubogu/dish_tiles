<!-- =====================================================================================================
    Name:          sensor-tile
    Author:        @michaelonubogu
    Description:   Displays sensor-tile data (dish data)
    ====================================================================================================-->

<polymer-element name="nam-weather-display">
    <!-- Polymer Core Components -->
    <link rel="import" href="../../components/core-drawer-panel/core-drawer-panel.html">
    <link rel="import" href="../../components/core-menu/core-menu.html">
    <link rel="import" href="../../components/core-item/core-item.html">
    <link rel="import" href="../../components/core-header-panel/core-header-panel.html">
    <link rel="import" href="../../components/core-toolbar/core-toolbar.html">
    <link rel="import" href="../../components/core-icon-button/core-icon-button.html">

    <link rel="import" href="../../components/core-animated-pages/core-animated-pages.html">
    <link rel="import" href="../../components/core-animated-pages/transitions/slide-from-right.html">

    <link rel="import" href="../../components/core-icons/core-icons.html">
    <link rel="import" href="../../components/core-icons/av-icons.html">
    <link rel="import" href="../../components/core-icons/communication-icons.html">
    <link rel="import" href="../../components/core-icons/device-icons.html">
    <link rel="import" href="../../components/core-icons/editor-icons.html">
    <link rel="import" href="../../components/core-icons/hardware-icons.html">
    <link rel="import" href="../../components/core-icons/image-icons.html">
    <link rel="import" href="../../components/core-icons/maps-icons.html">
    <link rel="import" href="../../components/core-icons/notification-icons.html">
    <link rel="import" href="../../components/core-icons/social-icons.html">

    <!-- Polymer Paper Components -->
    <link rel="import" href="../../components/paper-ripple/paper-ripple.html">
    <link rel="import" href="../../components/paper-item/paper-item.html">
    <link rel="import" href="../../components/paper-tabs/paper-tabs.html">

    <link rel="import" href="../open-sans.html">

    <template>
        <style>
            :host{
                font-family: 'Open Sans', sans-serif;
                /*text-shadow: 1px 1px 1px #666565;*/
            }

            .weather-value{
                font-size: 20vh;
            }

            .weather-location{
                font-size: 10vh;
            }

            h1, h2, h3, h4, h5, h6 {
                color: #ffffff;
                text-shadow:1px 1px 1px #7e7e7e;
            }
        </style>

        <template if="{{size == 'half'}}">
            <style>

            </style>
        </template>

        <template if="{{size == 'regular'}}">
            <style>

            </style>
        </template>

        <template if="{{size == 'double'}}">
            <style>

            </style>
        </template>

        <template if="{{size == 'triple'}}">
            <style>

            </style>
        </template>

        <template if="{{size == 'quadro'}}">
            <style>

            </style>
        </template>

        <div fit layout center vertical>
            <h1 class="weather-value">{{temperature.F}}&deg;{{unit}}</h1>
            <h3 class="weather-location">{{city}}, {{state}}</h3>
        </div>
    </template>


    <script>
        (function(){
            var wwo_api_key = '8ecacbd1f61a0ac9190af2d840262';
            var wwo_api_url = 'http://api.worldweatheronline.com/free/v2/weather.ashx';
            var http = new XMLHttpRequest();

            /* Polymer starts right here*/
            Polymer('nam-weather-display', {
                /**
                 * Specifies whether the size of the tile on load.
                 * sizes: ['half', 'regular', 'double', 'triple', 'quadro']
                 *
                 * @attribute size
                 * @type string
                 * @default 'regular'
                 */
                size: 'regular',

                /**
                 * Display weather info passed in
                 */
                displayWeather: function(data){
                    this.temperature = { F: 64, C: 0, K: 0 };
                    this.city = 'Roswell';
                    this.state = 'GA';
                    this.country = 'USA';
                    this.currTime = new Date().getTime();
                    this.unit = 'F'; //default
                },

                /**
                 * rearranges dish tile layout based on window resize
                 */
                rearrangeElements: function(){

                },

                ready: function(){
                    var self = this /* instance of polymer */
                    window.resizeStop.bind(this.rearrangeElements);
                    //startWeatherProcess();
                    this.displayWeather(null); //testing...
                }
            });

            function startWeatherProcess(){
                if(navigator.geolocation){
                    navigator.geolocation.getCurrentPosition(function(position){
                        var data = getWeather(position);
                        if(data !== null){
                            //render weather info with Polymer
                            Polymer.displayWeather(data);
                        }
                        else {
                            getWeatherFromService(position);
                        }
                    });
                }
                else { /*alert("I wasn't able to get your location. Sorry...");*/}
            }

            function getWeather(position){
                if(Modernizr.localstorage /* Probably uneccessary */){
                    var weather_data = localStorage.getItem('weather_data');

                    if(weather_data !== null && weather_data !== undefined){
                        var time = new Date().getTime() / 1000;
                        if(time - weather_data.time < 20000){
                            return weather_data.data;
                        }
                    }
                }
                return null; //no data in cache or cache expired
            }

            function getWeatherFromService(position){
                var weather_url = wwo_api_url + '';
                http.open("GET", weather_url);
                http.onload = function(){ receiveWeather(http); }
                http.send();
            }

            function receiveWeather(http){
                if(http.readyState == 4 && http.status == 200){
                    var weather_info = JSON.parse(http.responseText);

                    //cache in localstorage
                    localStorage.setItem('weather_data', { data: weather_info, time : (new Date().getTime() / 1000) });
                    //render weather info with Polymer
                    Polymer.displayWeather(weather_info);
                }
            }

        })();
    </script>
</polymer-element>